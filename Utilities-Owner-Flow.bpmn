<?xml version="1.0" encoding="UTF-8"?>
<!--
  Utilities — Owner (Business) User Flow — BPMN 2.0
  Three Participants: Owner, System, Paynet
  All exclusive gateways modeled per the Mermaid diagrams in Utilities - Business Owner.md

  Note: This file contains the semantic BPMN model only (no BPMNDiagram/DI layout).
  Import into any BPMN 2.0 modeler (e.g. Camunda Modeler, bpmn.io) to auto-generate layout.
-->
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             id="Definitions_OwnerFlow"
             targetNamespace="http://bpmn.io/schema/bpmn"
             exporter="Manual"
             exporterVersion="1.0.0">

  <!-- ===================================================================== -->
  <!-- COLLABORATION — defines the three pools and message flows between them -->
  <!-- ===================================================================== -->
  <collaboration id="Collab_OwnerUtilityFlow">
    <participant id="Pool_Owner" name="Owner" processRef="Process_Owner" />
    <participant id="Pool_System" name="System" processRef="Process_System" />
    <participant id="Pool_Paynet" name="Paynet" processRef="Process_Paynet" />

    <!-- Step 3: Manage Meters -->
    <messageFlow id="mf_s3_owner_system" name="Submit Meter Form" sourceRef="task_s3_o_submitForm" targetRef="task_s3_sys_receiveForm" />
    <messageFlow id="mf_s3_system_owner" name="Meter Save Result" sourceRef="task_s3_sys_sendResult" targetRef="task_s3_o_receiveResult" />

    <!-- Step 4.1: Submit Meter Readings -->
    <messageFlow id="mf_s4_1_owner_system" name="Submit Meter Reading" sourceRef="task_s4_1_o_submitReading" targetRef="task_s4_1_sys_receiveReading" />

    <!-- Step 4.2: Submit Non-Meter Readings -->
    <messageFlow id="mf_s4_2_owner_system" name="Submit Non-Meter Reading" sourceRef="task_s4_2_o_submitReading" targetRef="task_s4_2_sys_receiveReading" />

    <!-- Step 5: Manage Accounts — Owner ↔ System ↔ Paynet -->
    <messageFlow id="mf_s5_owner_system" name="Submit Account" sourceRef="task_s5_o_submitAccount" targetRef="task_s5_sys_receiveAccount" />
    <messageFlow id="mf_s5_system_paynet" name="Validate Account Request" sourceRef="task_s5_sys_sendToPaynet" targetRef="task_s5_pn_receiveValidation" />
    <messageFlow id="mf_s5_paynet_system" name="Validation Result" sourceRef="task_s5_pn_sendResult" targetRef="task_s5_sys_receivePaynetResult" />
    <messageFlow id="mf_s5_system_owner_ok" name="Account Saved" sourceRef="task_s5_sys_sendResultToOwner" targetRef="task_s5_o_receiveResult" />

    <!-- Step 6: Billing — System → Owner (display) -->
    <messageFlow id="mf_s6_system_owner" name="Display Charges" sourceRef="task_s6_sys_sendCharges" targetRef="task_s6_o_receiveCharges" />

    <!-- Step 6.1: Non-Metered Settlement — System auto-trigger -->
    <!-- (No message flow to Owner — billing is automatic; charges appear in payer's view) -->

    <!-- Step 7: Payment History — System → Owner (display) -->
    <messageFlow id="mf_s7_system_owner" name="Payment History Data" sourceRef="task_s7_sys_sendHistory" targetRef="task_s7_o_receiveHistory" />

    <!-- Step 8: Auto-Pay — System → Owner (display) -->
    <messageFlow id="mf_s8_system_owner" name="Auto-Pay Info" sourceRef="task_s8_sys_sendInfo" targetRef="task_s8_o_receiveInfo" />

    <!-- Step 9: Owner Payment — Owner ↔ System ↔ Paynet -->
    <messageFlow id="mf_s9_owner_system_pay" name="Payment Request" sourceRef="task_s9_o_confirmPayment" targetRef="task_s9_sys_receivePayment" />
    <messageFlow id="mf_s9_system_owner_otp" name="Send OTP" sourceRef="task_s9_sys_sendOTP" targetRef="task_s9_o_receiveOTP" />
    <messageFlow id="mf_s9_owner_system_otp" name="Enter OTP" sourceRef="task_s9_o_enterOTP" targetRef="task_s9_sys_receiveOTP" />
    <messageFlow id="mf_s9_system_paynet" name="Process Payment" sourceRef="task_s9_sys_sendToPaynet" targetRef="task_s9_pn_receivePayment" />
    <messageFlow id="mf_s9_paynet_system" name="Payment Result" sourceRef="task_s9_pn_sendResult" targetRef="task_s9_sys_receivePaynetResult" />
    <messageFlow id="mf_s9_system_owner_receipt" name="Payment Receipt" sourceRef="task_s9_sys_sendReceipt" targetRef="task_s9_o_receiveReceipt" />

    <!-- Step 10: Tenant Changes — System → Owner (alert) -->
    <messageFlow id="mf_s10_system_owner" name="Vacancy Alert" sourceRef="task_s10_sys_sendAlert" targetRef="task_s10_o_receiveAlert" />
  </collaboration>

  <!-- ===================================================================== -->
  <!-- PROCESS: OWNER                                                        -->
  <!-- ===================================================================== -->
  <process id="Process_Owner" name="Owner" isExecutable="false">

    <!-- ─── Step 1: Utilities Dashboard ─── -->
    <startEvent id="start_s1_o" name="Owner opens Utilities" />
    <task id="task_s1_o_viewDashboard" name="View Utilities Dashboard" />
    <task id="task_s1_o_viewActionItems" name="View Action Items (Overdue / Unpaid / Partially paid / Paid utilities)" />
    <task id="task_s1_o_viewSummary" name="View Monthly Summary (Total Charges, Collected, Outstanding, Owner Payable)" />
    <task id="task_s1_o_viewProperties" name="View Property List with utility status" />
    <task id="task_s1_o_viewMyBills" name="View My Payable Bills across all properties" />
    <endEvent id="end_s1_o" name="Dashboard viewed" />

    <sequenceFlow id="sf_s1_1" sourceRef="start_s1_o" targetRef="task_s1_o_viewDashboard" />
    <sequenceFlow id="sf_s1_2" sourceRef="task_s1_o_viewDashboard" targetRef="task_s1_o_viewActionItems" />
    <sequenceFlow id="sf_s1_3" sourceRef="task_s1_o_viewActionItems" targetRef="task_s1_o_viewSummary" />
    <sequenceFlow id="sf_s1_4" sourceRef="task_s1_o_viewSummary" targetRef="task_s1_o_viewProperties" />
    <sequenceFlow id="sf_s1_5" sourceRef="task_s1_o_viewProperties" targetRef="task_s1_o_viewMyBills" />
    <sequenceFlow id="sf_s1_6" sourceRef="task_s1_o_viewMyBills" targetRef="end_s1_o" />

    <!-- ─── Step 2: Property Utility Overview ─── -->
    <startEvent id="start_s2_o" name="Owner taps property from Dashboard" />
    <task id="task_s2_o_selectProperty" name="Select Property (e.g. Apartment 12, Building A-1)" />
    <task id="task_s2_o_viewOverview" name="View Property Utility Overview (Meters, Accounts, Readings, Billing, My Bills, Payments, Auto-Pay)" />
    <endEvent id="end_s2_o" name="Property overview viewed" />

    <sequenceFlow id="sf_s2_1" sourceRef="start_s2_o" targetRef="task_s2_o_selectProperty" />
    <sequenceFlow id="sf_s2_2" sourceRef="task_s2_o_selectProperty" targetRef="task_s2_o_viewOverview" />
    <sequenceFlow id="sf_s2_3" sourceRef="task_s2_o_viewOverview" targetRef="end_s2_o" />

    <!-- ─── Step 3: Manage Meters ─── -->
    <startEvent id="start_s3_o" name="Owner opens Meters tab" />
    <task id="task_s3_o_viewMeterList" name="View Meter List (Elektroenergiya, Sovuq suv, Tabiiy Gaz)" />
    <exclusiveGateway id="gw_s3_o_action" name="Add or Edit?" />
    <task id="task_s3_o_addMeter" name="Fill Add Meter Form (Meter Type, Лицевой счет)" />
    <task id="task_s3_o_editMeter" name="Fill Edit Meter Form (pre-filled)" />
    <exclusiveGateway id="gw_s3_o_mergeAction" name="Merge" />
    <task id="task_s3_o_submitForm" name="Submit Meter Form" />
    <task id="task_s3_o_receiveResult" name="Receive Save Result" />
    <exclusiveGateway id="gw_s3_o_valid" name="Valid?" />
    <task id="task_s3_o_meterAdded" name="Meter saved successfully" />
    <task id="task_s3_o_showError" name="Show Validation Errors" />
    <endEvent id="end_s3_o" name="Meter management complete" />

    <sequenceFlow id="sf_s3_1" sourceRef="start_s3_o" targetRef="task_s3_o_viewMeterList" />
    <sequenceFlow id="sf_s3_2" sourceRef="task_s3_o_viewMeterList" targetRef="gw_s3_o_action" />
    <sequenceFlow id="sf_s3_3" name="Add Meter" sourceRef="gw_s3_o_action" targetRef="task_s3_o_addMeter" />
    <sequenceFlow id="sf_s3_4" name="Edit Meter" sourceRef="gw_s3_o_action" targetRef="task_s3_o_editMeter" />
    <sequenceFlow id="sf_s3_5" sourceRef="task_s3_o_addMeter" targetRef="gw_s3_o_mergeAction" />
    <sequenceFlow id="sf_s3_6" sourceRef="task_s3_o_editMeter" targetRef="gw_s3_o_mergeAction" />
    <sequenceFlow id="sf_s3_7" sourceRef="gw_s3_o_mergeAction" targetRef="task_s3_o_submitForm" />
    <sequenceFlow id="sf_s3_8" sourceRef="task_s3_o_submitForm" targetRef="task_s3_o_receiveResult" />
    <sequenceFlow id="sf_s3_9" sourceRef="task_s3_o_receiveResult" targetRef="gw_s3_o_valid" />
    <sequenceFlow id="sf_s3_10" name="Yes" sourceRef="gw_s3_o_valid" targetRef="task_s3_o_meterAdded" />
    <sequenceFlow id="sf_s3_11" name="No" sourceRef="gw_s3_o_valid" targetRef="task_s3_o_showError" />
    <sequenceFlow id="sf_s3_12" sourceRef="task_s3_o_meterAdded" targetRef="end_s3_o" />
    <sequenceFlow id="sf_s3_13" sourceRef="task_s3_o_showError" targetRef="task_s3_o_addMeter" />

    <!-- ─── Step 4.1: Submit Meter Readings ─── -->
    <startEvent id="start_s4_1_o" name="Owner opens Submit Readings" />
    <task id="task_s4_1_o_selectMeter" name="Select meter and enter current reading" />
    <task id="task_s4_1_o_submitReading" name="Submit meter reading" />
    <endEvent id="end_s4_1_o" name="Meter reading submitted" />

    <sequenceFlow id="sf_s4_1_1" sourceRef="start_s4_1_o" targetRef="task_s4_1_o_selectMeter" />
    <sequenceFlow id="sf_s4_1_2" sourceRef="task_s4_1_o_selectMeter" targetRef="task_s4_1_o_submitReading" />
    <sequenceFlow id="sf_s4_1_3" sourceRef="task_s4_1_o_submitReading" targetRef="end_s4_1_o" />

    <!-- ─── Step 4.2: Submit Non-Meter Readings ─── -->
    <startEvent id="start_s4_2_o" name="Owner opens Submit Readings (Non-Metered)" />
    <task id="task_s4_2_o_selectAccount" name="Select non-metered utility account" />
    <task id="task_s4_2_o_enterVariable" name="Enter / update calculation variable (based on utility type)" />
    <task id="task_s4_2_o_submitReading" name="Submit non-meter reading" />
    <endEvent id="end_s4_2_o" name="Non-meter reading submitted" />

    <sequenceFlow id="sf_s4_2_1" sourceRef="start_s4_2_o" targetRef="task_s4_2_o_selectAccount" />
    <sequenceFlow id="sf_s4_2_2" sourceRef="task_s4_2_o_selectAccount" targetRef="task_s4_2_o_enterVariable" />
    <sequenceFlow id="sf_s4_2_3" sourceRef="task_s4_2_o_enterVariable" targetRef="task_s4_2_o_submitReading" />
    <sequenceFlow id="sf_s4_2_4" sourceRef="task_s4_2_o_submitReading" targetRef="end_s4_2_o" />

    <!-- ─── Step 5: Manage Utility Accounts ─── -->
    <startEvent id="start_s5_o" name="Owner opens Utility Accounts" />
    <task id="task_s5_o_viewAccounts" name="View existing utility accounts" />
    <task id="task_s5_o_selectType" name="Select Utility Type (Electricity, Gas, Water, ...)" />
    <task id="task_s5_o_selectProvider" name="Select Provider (filtered by utility type)" />
    <task id="task_s5_o_enterDetails" name="Enter Account Number" />
    <task id="task_s5_o_setResponsibility" name="Set Payment Responsibility (Tenant default / Owner)" />
    <task id="task_s5_o_submitAccount" name="Submit account for validation" />
    <task id="task_s5_o_receiveResult" name="Receive validation result" />
    <exclusiveGateway id="gw_s5_o_valid" name="Account Valid?" />
    <task id="task_s5_o_accountSaved" name="Account saved — visible to tenant" />
    <task id="task_s5_o_showError" name="Account not found — check number and retry" />
    <endEvent id="end_s5_o" name="Account management complete" />

    <sequenceFlow id="sf_s5_1" sourceRef="start_s5_o" targetRef="task_s5_o_viewAccounts" />
    <sequenceFlow id="sf_s5_2" sourceRef="task_s5_o_viewAccounts" targetRef="task_s5_o_selectType" />
    <sequenceFlow id="sf_s5_3" sourceRef="task_s5_o_selectType" targetRef="task_s5_o_selectProvider" />
    <sequenceFlow id="sf_s5_4" sourceRef="task_s5_o_selectProvider" targetRef="task_s5_o_enterDetails" />
    <sequenceFlow id="sf_s5_5" sourceRef="task_s5_o_enterDetails" targetRef="task_s5_o_setResponsibility" />
    <sequenceFlow id="sf_s5_6" sourceRef="task_s5_o_setResponsibility" targetRef="task_s5_o_submitAccount" />
    <sequenceFlow id="sf_s5_7" sourceRef="task_s5_o_submitAccount" targetRef="task_s5_o_receiveResult" />
    <sequenceFlow id="sf_s5_8" sourceRef="task_s5_o_receiveResult" targetRef="gw_s5_o_valid" />
    <sequenceFlow id="sf_s5_9" name="Valid" sourceRef="gw_s5_o_valid" targetRef="task_s5_o_accountSaved" />
    <sequenceFlow id="sf_s5_10" name="Invalid" sourceRef="gw_s5_o_valid" targetRef="task_s5_o_showError" />
    <sequenceFlow id="sf_s5_11" sourceRef="task_s5_o_accountSaved" targetRef="end_s5_o" />
    <sequenceFlow id="sf_s5_12" sourceRef="task_s5_o_showError" targetRef="task_s5_o_enterDetails" />

    <!-- ─── Step 6: Billing Management (Owner view) ─── -->
    <startEvent id="start_s6_o" name="Owner opens Billing" />
    <task id="task_s6_o_receiveCharges" name="View charges for selected month (metered + non-metered)" />
    <endEvent id="end_s6_o" name="Billing viewed" />

    <sequenceFlow id="sf_s6_1" sourceRef="start_s6_o" targetRef="task_s6_o_receiveCharges" />
    <sequenceFlow id="sf_s6_2" sourceRef="task_s6_o_receiveCharges" targetRef="end_s6_o" />

    <!-- ─── Step 7: Payment History (Owner view) ─── -->
    <startEvent id="start_s7_o" name="Owner opens Payment History" />
    <task id="task_s7_o_setFilters" name="Set Filters (Property, Tenant, Status, Date Range, Provider)" />
    <task id="task_s7_o_receiveHistory" name="View Payment History" />
    <task id="task_s7_o_viewReceipt" name="Tap payment → View Receipt (Transaction ID, method, date, auto-pay)" />
    <task id="task_s7_o_exportPDF" name="Download as PDF" />
    <endEvent id="end_s7_o" name="Payment history viewed" />

    <sequenceFlow id="sf_s7_1" sourceRef="start_s7_o" targetRef="task_s7_o_setFilters" />
    <sequenceFlow id="sf_s7_2" sourceRef="task_s7_o_setFilters" targetRef="task_s7_o_receiveHistory" />
    <sequenceFlow id="sf_s7_3" sourceRef="task_s7_o_receiveHistory" targetRef="task_s7_o_viewReceipt" />
    <sequenceFlow id="sf_s7_4" sourceRef="task_s7_o_viewReceipt" targetRef="task_s7_o_exportPDF" />
    <sequenceFlow id="sf_s7_5" sourceRef="task_s7_o_exportPDF" targetRef="end_s7_o" />

    <!-- ─── Step 8: Auto-Pay Oversight (Read-Only) ─── -->
    <startEvent id="start_s8_o" name="Owner opens Auto-Pay Status" />
    <task id="task_s8_o_receiveInfo" name="View Tenant Auto-Pay Info (5 of 12 accounts active, 42% coverage)" />
    <endEvent id="end_s8_o" name="Auto-Pay viewed" />

    <sequenceFlow id="sf_s8_1" sourceRef="start_s8_o" targetRef="task_s8_o_receiveInfo" />
    <sequenceFlow id="sf_s8_2" sourceRef="task_s8_o_receiveInfo" targetRef="end_s8_o" />

    <!-- ─── Step 9: Owner Payment Flow ─── -->
    <startEvent id="start_s9_o" name="Owner opens My Payable Bills" />
    <task id="task_s9_o_selectBill" name="Select bill to pay" />
    <exclusiveGateway id="gw_s9_o_editAmount" name="Edit Amount?" />
    <task id="task_s9_o_payFull" name="Pay full balance" />
    <task id="task_s9_o_customAmount" name="Enter custom amount" />
    <exclusiveGateway id="gw_s9_o_mergeAmount" name="Merge amount" />
    <exclusiveGateway id="gw_s9_o_cardChoice" name="Card Selection?" />
    <task id="task_s9_o_newCard" name="Enter new card details (card number, expiry date)" />
    <task id="task_s9_o_savedCard" name="Select saved card" />

    <!-- New Card path -->
    <exclusiveGateway id="gw_s9_o_payOptNew" name="Payment Option (New Card)?" />
    <task id="task_s9_o_oneTimeNew" name="One-time payment" />
    <exclusiveGateway id="gw_s9_o_saveCard" name="Save Card?" />
    <task id="task_s9_o_tokenize" name="Tokenize and save card for future payments" />
    <exclusiveGateway id="gw_s9_o_mergeToOTP" name="Merge to OTP" />
    <task id="task_s9_o_scheduleNew" name="Set Auto-Pay Schedule (day of month + amount)" />
    <task id="task_s9_o_autoSave" name="Tokenize, save card, and activate auto-pay" />

    <!-- Saved Card path -->
    <exclusiveGateway id="gw_s9_o_payOptSaved" name="Payment Option (Saved Card)?" />
    <task id="task_s9_o_oneTimeSaved" name="One-time payment (saved card)" />
    <task id="task_s9_o_scheduleSaved" name="Set Auto-Pay Schedule (saved card)" />
    <exclusiveGateway id="gw_s9_o_mergeSavedToConfirm" name="Merge saved to confirm" />

    <!-- OTP flow (new card only) -->
    <task id="task_s9_o_receiveOTP" name="Receive OTP on registered phone" />
    <task id="task_s9_o_enterOTP" name="Enter OTP code" />

    <!-- Confirm and Receipt -->
    <task id="task_s9_o_confirmPayment" name="Confirm Payment (amount, provider, account)" />
    <task id="task_s9_o_receiveReceipt" name="View Payment Receipt (Payer: Owner Name)" />
    <endEvent id="end_s9_o" name="Payment complete" />

    <!-- Step 9 sequence flows -->
    <sequenceFlow id="sf_s9_1" sourceRef="start_s9_o" targetRef="task_s9_o_selectBill" />
    <sequenceFlow id="sf_s9_2" sourceRef="task_s9_o_selectBill" targetRef="gw_s9_o_editAmount" />
    <sequenceFlow id="sf_s9_3" name="Pay full balance" sourceRef="gw_s9_o_editAmount" targetRef="task_s9_o_payFull" />
    <sequenceFlow id="sf_s9_4" name="Custom amount" sourceRef="gw_s9_o_editAmount" targetRef="task_s9_o_customAmount" />
    <sequenceFlow id="sf_s9_5" sourceRef="task_s9_o_payFull" targetRef="gw_s9_o_mergeAmount" />
    <sequenceFlow id="sf_s9_6" sourceRef="task_s9_o_customAmount" targetRef="gw_s9_o_mergeAmount" />
    <sequenceFlow id="sf_s9_7" sourceRef="gw_s9_o_mergeAmount" targetRef="gw_s9_o_cardChoice" />
    <sequenceFlow id="sf_s9_8" name="New card" sourceRef="gw_s9_o_cardChoice" targetRef="task_s9_o_newCard" />
    <sequenceFlow id="sf_s9_9" name="Saved card" sourceRef="gw_s9_o_cardChoice" targetRef="task_s9_o_savedCard" />

    <!-- New Card sub-flow -->
    <sequenceFlow id="sf_s9_10" sourceRef="task_s9_o_newCard" targetRef="gw_s9_o_payOptNew" />
    <sequenceFlow id="sf_s9_11" name="One-time" sourceRef="gw_s9_o_payOptNew" targetRef="task_s9_o_oneTimeNew" />
    <sequenceFlow id="sf_s9_12" sourceRef="task_s9_o_oneTimeNew" targetRef="gw_s9_o_saveCard" />
    <sequenceFlow id="sf_s9_13" name="Yes" sourceRef="gw_s9_o_saveCard" targetRef="task_s9_o_tokenize" />
    <sequenceFlow id="sf_s9_14" name="No" sourceRef="gw_s9_o_saveCard" targetRef="gw_s9_o_mergeToOTP" />
    <sequenceFlow id="sf_s9_15" sourceRef="task_s9_o_tokenize" targetRef="gw_s9_o_mergeToOTP" />
    <sequenceFlow id="sf_s9_16" name="Auto-pay" sourceRef="gw_s9_o_payOptNew" targetRef="task_s9_o_scheduleNew" />
    <sequenceFlow id="sf_s9_17" sourceRef="task_s9_o_scheduleNew" targetRef="task_s9_o_autoSave" />
    <sequenceFlow id="sf_s9_18" sourceRef="task_s9_o_autoSave" targetRef="gw_s9_o_mergeToOTP" />
    <sequenceFlow id="sf_s9_19" sourceRef="gw_s9_o_mergeToOTP" targetRef="task_s9_o_receiveOTP" />
    <sequenceFlow id="sf_s9_20" sourceRef="task_s9_o_receiveOTP" targetRef="task_s9_o_enterOTP" />
    <sequenceFlow id="sf_s9_21" sourceRef="task_s9_o_enterOTP" targetRef="task_s9_o_confirmPayment" />

    <!-- Saved Card sub-flow -->
    <sequenceFlow id="sf_s9_22" sourceRef="task_s9_o_savedCard" targetRef="gw_s9_o_payOptSaved" />
    <sequenceFlow id="sf_s9_23" name="One-time" sourceRef="gw_s9_o_payOptSaved" targetRef="task_s9_o_oneTimeSaved" />
    <sequenceFlow id="sf_s9_24" name="Auto-pay" sourceRef="gw_s9_o_payOptSaved" targetRef="task_s9_o_scheduleSaved" />
    <sequenceFlow id="sf_s9_25" sourceRef="task_s9_o_oneTimeSaved" targetRef="gw_s9_o_mergeSavedToConfirm" />
    <sequenceFlow id="sf_s9_26" sourceRef="task_s9_o_scheduleSaved" targetRef="gw_s9_o_mergeSavedToConfirm" />
    <sequenceFlow id="sf_s9_27" sourceRef="gw_s9_o_mergeSavedToConfirm" targetRef="task_s9_o_confirmPayment" />

    <!-- Confirm → Receipt → End -->
    <sequenceFlow id="sf_s9_28" sourceRef="task_s9_o_confirmPayment" targetRef="task_s9_o_receiveReceipt" />
    <sequenceFlow id="sf_s9_29" sourceRef="task_s9_o_receiveReceipt" targetRef="end_s9_o" />

    <!-- ─── Step 10: Tenant Changes ─── -->
    <!-- 10.1 Move-Out -->
    <startEvent id="start_s10_o" name="Owner receives vacancy alert" />
    <task id="task_s10_o_receiveAlert" name="View: Vacant Property — accounts are unassigned" />
    <exclusiveGateway id="gw_s10_o_decision" name="Owner Decision?" />
    <task id="task_s10_o_takeResp" name="Take Responsibility (Owner pays)" />
    <task id="task_s10_o_assignNew" name="Assign to New Tenant" />
    <endEvent id="end_s10_o" name="Tenant change handled" />

    <sequenceFlow id="sf_s10_1" sourceRef="start_s10_o" targetRef="task_s10_o_receiveAlert" />
    <sequenceFlow id="sf_s10_2" sourceRef="task_s10_o_receiveAlert" targetRef="gw_s10_o_decision" />
    <sequenceFlow id="sf_s10_3" name="Take Responsibility" sourceRef="gw_s10_o_decision" targetRef="task_s10_o_takeResp" />
    <sequenceFlow id="sf_s10_4" name="Assign to New Tenant" sourceRef="gw_s10_o_decision" targetRef="task_s10_o_assignNew" />
    <sequenceFlow id="sf_s10_5" sourceRef="task_s10_o_takeResp" targetRef="end_s10_o" />
    <sequenceFlow id="sf_s10_6" sourceRef="task_s10_o_assignNew" targetRef="end_s10_o" />

    <!-- 10.2 Move-In -->
    <startEvent id="start_s10_2_o" name="Owner creates new lease" />
    <task id="task_s10_2_o_selectProperty" name="Select Property" />
    <task id="task_s10_2_o_setResponsibility" name="Set responsibility for each linked account (Tenant / Owner)" />
    <endEvent id="end_s10_2_o" name="Utility responsibility assigned" />

    <sequenceFlow id="sf_s10_2_1" sourceRef="start_s10_2_o" targetRef="task_s10_2_o_selectProperty" />
    <sequenceFlow id="sf_s10_2_2" sourceRef="task_s10_2_o_selectProperty" targetRef="task_s10_2_o_setResponsibility" />
    <sequenceFlow id="sf_s10_2_3" sourceRef="task_s10_2_o_setResponsibility" targetRef="end_s10_2_o" />
  </process>

  <!-- ===================================================================== -->
  <!-- PROCESS: SYSTEM                                                       -->
  <!-- ===================================================================== -->
  <process id="Process_System" name="System" isExecutable="false">

    <!-- ─── Step 3: Process Meter Form ─── -->
    <startEvent id="start_s3_sys" name="Receive meter form from Owner" />
    <task id="task_s3_sys_receiveForm" name="Receive meter form" />
    <exclusiveGateway id="gw_s3_sys_valid" name="Meter form valid?" />
    <task id="task_s3_sys_saveMeter" name="Save meter and link to Utility Account" />
    <task id="task_s3_sys_returnError" name="Return validation errors" />
    <task id="task_s3_sys_sendResult" name="Send result to Owner" />
    <endEvent id="end_s3_sys" name="Meter processed" />

    <sequenceFlow id="sf_s3_sys_1" sourceRef="start_s3_sys" targetRef="task_s3_sys_receiveForm" />
    <sequenceFlow id="sf_s3_sys_2" sourceRef="task_s3_sys_receiveForm" targetRef="gw_s3_sys_valid" />
    <sequenceFlow id="sf_s3_sys_3" name="Yes" sourceRef="gw_s3_sys_valid" targetRef="task_s3_sys_saveMeter" />
    <sequenceFlow id="sf_s3_sys_4" name="No" sourceRef="gw_s3_sys_valid" targetRef="task_s3_sys_returnError" />
    <sequenceFlow id="sf_s3_sys_5" sourceRef="task_s3_sys_saveMeter" targetRef="task_s3_sys_sendResult" />
    <sequenceFlow id="sf_s3_sys_6" sourceRef="task_s3_sys_returnError" targetRef="task_s3_sys_sendResult" />
    <sequenceFlow id="sf_s3_sys_7" sourceRef="task_s3_sys_sendResult" targetRef="end_s3_sys" />

    <!-- ─── Step 4.1: Process Meter Reading ─── -->
    <startEvent id="start_s4_1_sys" name="Receive meter reading" />
    <task id="task_s4_1_sys_receiveReading" name="Receive meter reading from Owner" />
    <task id="task_s4_1_sys_calculateCost" name="Calculate cost: Consumption × Tariff" />
    <exclusiveGateway id="gw_s4_1_sys_responsibility" name="Responsibility on this Account?" />
    <task id="task_s4_1_sys_billTenant" name="Bill sent to Tenant as pending payment" />
    <task id="task_s4_1_sys_billOwner" name="Bill added to Owner's Payables" />
    <endEvent id="end_s4_1_sys" name="Meter reading processed" />

    <sequenceFlow id="sf_s4_1_sys_1" sourceRef="start_s4_1_sys" targetRef="task_s4_1_sys_receiveReading" />
    <sequenceFlow id="sf_s4_1_sys_2" sourceRef="task_s4_1_sys_receiveReading" targetRef="task_s4_1_sys_calculateCost" />
    <sequenceFlow id="sf_s4_1_sys_3" sourceRef="task_s4_1_sys_calculateCost" targetRef="gw_s4_1_sys_responsibility" />
    <sequenceFlow id="sf_s4_1_sys_4" name="Tenant" sourceRef="gw_s4_1_sys_responsibility" targetRef="task_s4_1_sys_billTenant" />
    <sequenceFlow id="sf_s4_1_sys_5" name="Owner" sourceRef="gw_s4_1_sys_responsibility" targetRef="task_s4_1_sys_billOwner" />
    <sequenceFlow id="sf_s4_1_sys_6" sourceRef="task_s4_1_sys_billTenant" targetRef="end_s4_1_sys" />
    <sequenceFlow id="sf_s4_1_sys_7" sourceRef="task_s4_1_sys_billOwner" targetRef="end_s4_1_sys" />

    <!-- ─── Step 4.2: Process Non-Meter Reading ─── -->
    <startEvent id="start_s4_2_sys" name="Receive non-meter reading" />
    <task id="task_s4_2_sys_receiveReading" name="Receive non-meter reading from Owner" />
    <exclusiveGateway id="gw_s4_2_sys_variableType" name="Variable Type?" />
    <task id="task_s4_2_sys_calcPerResident" name="Calculate: Tariff × Residents (e.g. 5,000 × 5 = 25,000 UZS)" />
    <task id="task_s4_2_sys_calcPerArea" name="Calculate: Tariff × Area (e.g. 2,000 × 40 m² = 80,000 UZS)" />
    <exclusiveGateway id="gw_s4_2_sys_mergeCalc" name="Merge calculation" />
    <exclusiveGateway id="gw_s4_2_sys_responsibility" name="Responsibility on this Account?" />
    <task id="task_s4_2_sys_billTenant" name="Bill sent to Tenant as pending payment" />
    <task id="task_s4_2_sys_billOwner" name="Bill added to Owner's Payables" />
    <endEvent id="end_s4_2_sys" name="Non-meter reading processed" />

    <sequenceFlow id="sf_s4_2_sys_1" sourceRef="start_s4_2_sys" targetRef="task_s4_2_sys_receiveReading" />
    <sequenceFlow id="sf_s4_2_sys_2" sourceRef="task_s4_2_sys_receiveReading" targetRef="gw_s4_2_sys_variableType" />
    <sequenceFlow id="sf_s4_2_sys_3" name="Per Resident" sourceRef="gw_s4_2_sys_variableType" targetRef="task_s4_2_sys_calcPerResident" />
    <sequenceFlow id="sf_s4_2_sys_4" name="Per Area (m²)" sourceRef="gw_s4_2_sys_variableType" targetRef="task_s4_2_sys_calcPerArea" />
    <sequenceFlow id="sf_s4_2_sys_5" sourceRef="task_s4_2_sys_calcPerResident" targetRef="gw_s4_2_sys_mergeCalc" />
    <sequenceFlow id="sf_s4_2_sys_6" sourceRef="task_s4_2_sys_calcPerArea" targetRef="gw_s4_2_sys_mergeCalc" />
    <sequenceFlow id="sf_s4_2_sys_7" sourceRef="gw_s4_2_sys_mergeCalc" targetRef="gw_s4_2_sys_responsibility" />
    <sequenceFlow id="sf_s4_2_sys_8" name="Tenant" sourceRef="gw_s4_2_sys_responsibility" targetRef="task_s4_2_sys_billTenant" />
    <sequenceFlow id="sf_s4_2_sys_9" name="Owner" sourceRef="gw_s4_2_sys_responsibility" targetRef="task_s4_2_sys_billOwner" />
    <sequenceFlow id="sf_s4_2_sys_10" sourceRef="task_s4_2_sys_billTenant" targetRef="end_s4_2_sys" />
    <sequenceFlow id="sf_s4_2_sys_11" sourceRef="task_s4_2_sys_billOwner" targetRef="end_s4_2_sys" />

    <!-- ─── Step 5: Validate Account via Paynet ─── -->
    <startEvent id="start_s5_sys" name="Receive account from Owner" />
    <task id="task_s5_sys_receiveAccount" name="Receive account details from Owner" />
    <task id="task_s5_sys_sendToPaynet" name="Send account number to Paynet for validation" />
    <task id="task_s5_sys_receivePaynetResult" name="Receive validation result from Paynet" />
    <exclusiveGateway id="gw_s5_sys_valid" name="Account Valid?" />
    <task id="task_s5_sys_saveAccount" name="Save Account with Responsibility Settings" />
    <task id="task_s5_sys_returnError" name="Return error: Account not found" />
    <task id="task_s5_sys_sendResultToOwner" name="Send result to Owner" />
    <endEvent id="end_s5_sys" name="Account processed" />

    <sequenceFlow id="sf_s5_sys_1" sourceRef="start_s5_sys" targetRef="task_s5_sys_receiveAccount" />
    <sequenceFlow id="sf_s5_sys_2" sourceRef="task_s5_sys_receiveAccount" targetRef="task_s5_sys_sendToPaynet" />
    <sequenceFlow id="sf_s5_sys_3" sourceRef="task_s5_sys_sendToPaynet" targetRef="task_s5_sys_receivePaynetResult" />
    <sequenceFlow id="sf_s5_sys_4" sourceRef="task_s5_sys_receivePaynetResult" targetRef="gw_s5_sys_valid" />
    <sequenceFlow id="sf_s5_sys_5" name="Valid" sourceRef="gw_s5_sys_valid" targetRef="task_s5_sys_saveAccount" />
    <sequenceFlow id="sf_s5_sys_6" name="Invalid" sourceRef="gw_s5_sys_valid" targetRef="task_s5_sys_returnError" />
    <sequenceFlow id="sf_s5_sys_7" sourceRef="task_s5_sys_saveAccount" targetRef="task_s5_sys_sendResultToOwner" />
    <sequenceFlow id="sf_s5_sys_8" sourceRef="task_s5_sys_returnError" targetRef="task_s5_sys_sendResultToOwner" />
    <sequenceFlow id="sf_s5_sys_9" sourceRef="task_s5_sys_sendResultToOwner" targetRef="end_s5_sys" />

    <!-- ─── Step 6: Billing Management ─── -->
    <startEvent id="start_s6_sys" name="Owner requests billing view" />
    <task id="task_s6_sys_loadCharges" name="Load charges for selected month" />
    <task id="task_s6_sys_displayMetered" name="Display Metered Charges (from meter readings × tariff)" />
    <task id="task_s6_sys_displayNonMetered" name="Display Non-Metered Charges (tariff × variable)" />
    <task id="task_s6_sys_sendCharges" name="Send charges to Owner view" />
    <endEvent id="end_s6_sys" name="Billing displayed" />

    <sequenceFlow id="sf_s6_sys_1" sourceRef="start_s6_sys" targetRef="task_s6_sys_loadCharges" />
    <sequenceFlow id="sf_s6_sys_2" sourceRef="task_s6_sys_loadCharges" targetRef="task_s6_sys_displayMetered" />
    <sequenceFlow id="sf_s6_sys_3" sourceRef="task_s6_sys_displayMetered" targetRef="task_s6_sys_displayNonMetered" />
    <sequenceFlow id="sf_s6_sys_4" sourceRef="task_s6_sys_displayNonMetered" targetRef="task_s6_sys_sendCharges" />
    <sequenceFlow id="sf_s6_sys_5" sourceRef="task_s6_sys_sendCharges" targetRef="end_s6_sys" />

    <!-- ─── Step 6.1: Non-Metered Settlement Flow (Auto-triggered) ─── -->
    <startEvent id="start_s6_1_sys" name="Monthly non-metered billing triggered (timer)">
      <timerEventDefinition>
        <timeCycle>R/P1M</timeCycle>
      </timerEventDefinition>
    </startEvent>
    <task id="task_s6_1_sys_determine" name="Determine calculation category based on service type (using saved variable from Step 4.2)" />
    <exclusiveGateway id="gw_s6_1_sys_calcType" name="Calculation Variable?" />
    <task id="task_s6_1_sys_perResident" name="Calculate: Tariff × Number of Residents (e.g. 5,000 × 5 = 25,000 UZS)" />
    <task id="task_s6_1_sys_perArea" name="Calculate: Tariff × Area (e.g. 2,000 × 40 m² = 80,000 UZS)" />
    <exclusiveGateway id="gw_s6_1_sys_mergeCalc" name="Merge calculation" />
    <task id="task_s6_1_sys_createCharge" name="Create utility charge (amount known)" />
    <exclusiveGateway id="gw_s6_1_sys_responsibility" name="Responsibility on this Account?" />
    <task id="task_s6_1_sys_billTenant" name="Bill sent to Tenant as pending payment" />
    <task id="task_s6_1_sys_billOwner" name="Bill added to Owner's Payables" />
    <endEvent id="end_s6_1_sys" name="Non-metered charge generated" />

    <sequenceFlow id="sf_s6_1_sys_1" sourceRef="start_s6_1_sys" targetRef="task_s6_1_sys_determine" />
    <sequenceFlow id="sf_s6_1_sys_2" sourceRef="task_s6_1_sys_determine" targetRef="gw_s6_1_sys_calcType" />
    <sequenceFlow id="sf_s6_1_sys_3" name="Per Resident" sourceRef="gw_s6_1_sys_calcType" targetRef="task_s6_1_sys_perResident" />
    <sequenceFlow id="sf_s6_1_sys_4" name="Per Area (m²)" sourceRef="gw_s6_1_sys_calcType" targetRef="task_s6_1_sys_perArea" />
    <sequenceFlow id="sf_s6_1_sys_5" sourceRef="task_s6_1_sys_perResident" targetRef="gw_s6_1_sys_mergeCalc" />
    <sequenceFlow id="sf_s6_1_sys_6" sourceRef="task_s6_1_sys_perArea" targetRef="gw_s6_1_sys_mergeCalc" />
    <sequenceFlow id="sf_s6_1_sys_7" sourceRef="gw_s6_1_sys_mergeCalc" targetRef="task_s6_1_sys_createCharge" />
    <sequenceFlow id="sf_s6_1_sys_8" sourceRef="task_s6_1_sys_createCharge" targetRef="gw_s6_1_sys_responsibility" />
    <sequenceFlow id="sf_s6_1_sys_9" name="Tenant pays" sourceRef="gw_s6_1_sys_responsibility" targetRef="task_s6_1_sys_billTenant" />
    <sequenceFlow id="sf_s6_1_sys_10" name="Owner pays" sourceRef="gw_s6_1_sys_responsibility" targetRef="task_s6_1_sys_billOwner" />
    <sequenceFlow id="sf_s6_1_sys_11" sourceRef="task_s6_1_sys_billTenant" targetRef="end_s6_1_sys" />
    <sequenceFlow id="sf_s6_1_sys_12" sourceRef="task_s6_1_sys_billOwner" targetRef="end_s6_1_sys" />

    <!-- ─── Step 7: Fetch Payment History ─── -->
    <startEvent id="start_s7_sys" name="Owner requests payment history" />
    <task id="task_s7_sys_fetchHistory" name="Fetch payment history with applied filters" />
    <task id="task_s7_sys_sendHistory" name="Send payment history to Owner" />
    <endEvent id="end_s7_sys" name="History sent" />

    <sequenceFlow id="sf_s7_sys_1" sourceRef="start_s7_sys" targetRef="task_s7_sys_fetchHistory" />
    <sequenceFlow id="sf_s7_sys_2" sourceRef="task_s7_sys_fetchHistory" targetRef="task_s7_sys_sendHistory" />
    <sequenceFlow id="sf_s7_sys_3" sourceRef="task_s7_sys_sendHistory" targetRef="end_s7_sys" />

    <!-- ─── Step 8: Fetch Auto-Pay Info ─── -->
    <startEvent id="start_s8_sys" name="Owner requests auto-pay info" />
    <task id="task_s8_sys_fetchInfo" name="Fetch tenant auto-pay configuration" />
    <task id="task_s8_sys_sendInfo" name="Send auto-pay info to Owner" />
    <endEvent id="end_s8_sys" name="Info sent" />

    <sequenceFlow id="sf_s8_sys_1" sourceRef="start_s8_sys" targetRef="task_s8_sys_fetchInfo" />
    <sequenceFlow id="sf_s8_sys_2" sourceRef="task_s8_sys_fetchInfo" targetRef="task_s8_sys_sendInfo" />
    <sequenceFlow id="sf_s8_sys_3" sourceRef="task_s8_sys_sendInfo" targetRef="end_s8_sys" />

    <!-- ─── Step 9: Process Owner Payment ─── -->
    <startEvent id="start_s9_sys" name="Payment request received" />
    <task id="task_s9_sys_receivePayment" name="Receive payment request from Owner" />
    <exclusiveGateway id="gw_s9_sys_newCard" name="New card requiring OTP?" />
    <task id="task_s9_sys_sendOTP" name="Send OTP to registered phone (card registration)" />
    <task id="task_s9_sys_receiveOTP" name="Receive OTP from Owner" />
    <exclusiveGateway id="gw_s9_sys_otpValid" name="OTP Valid?" />
    <task id="task_s9_sys_otpError" name="Return: Invalid OTP — code is incorrect or expired" />
    <exclusiveGateway id="gw_s9_sys_mergeToPaynet" name="Merge to Paynet" />
    <task id="task_s9_sys_sendToPaynet" name="Send payment to Paynet for processing" />
    <task id="task_s9_sys_receivePaynetResult" name="Receive payment result from Paynet" />
    <task id="task_s9_sys_generateReceipt" name="Generate Payment Receipt (Payer: Owner Name)" />
    <task id="task_s9_sys_sendReceipt" name="Send receipt to Owner" />
    <task id="task_s9_sys_updateTenantView" name="Update Tenant View: Paid by Owner" />
    <endEvent id="end_s9_sys" name="Payment processed" />

    <sequenceFlow id="sf_s9_sys_1" sourceRef="start_s9_sys" targetRef="task_s9_sys_receivePayment" />
    <sequenceFlow id="sf_s9_sys_2" sourceRef="task_s9_sys_receivePayment" targetRef="gw_s9_sys_newCard" />
    <sequenceFlow id="sf_s9_sys_3" name="Yes (new card)" sourceRef="gw_s9_sys_newCard" targetRef="task_s9_sys_sendOTP" />
    <sequenceFlow id="sf_s9_sys_4" name="No (saved card)" sourceRef="gw_s9_sys_newCard" targetRef="gw_s9_sys_mergeToPaynet" />
    <sequenceFlow id="sf_s9_sys_5" sourceRef="task_s9_sys_sendOTP" targetRef="task_s9_sys_receiveOTP" />
    <sequenceFlow id="sf_s9_sys_6" sourceRef="task_s9_sys_receiveOTP" targetRef="gw_s9_sys_otpValid" />
    <sequenceFlow id="sf_s9_sys_7" name="Yes" sourceRef="gw_s9_sys_otpValid" targetRef="gw_s9_sys_mergeToPaynet" />
    <sequenceFlow id="sf_s9_sys_8" name="No" sourceRef="gw_s9_sys_otpValid" targetRef="task_s9_sys_otpError" />
    <sequenceFlow id="sf_s9_sys_9" sourceRef="task_s9_sys_otpError" targetRef="task_s9_sys_receiveOTP" />
    <sequenceFlow id="sf_s9_sys_10" sourceRef="gw_s9_sys_mergeToPaynet" targetRef="task_s9_sys_sendToPaynet" />
    <sequenceFlow id="sf_s9_sys_11" sourceRef="task_s9_sys_sendToPaynet" targetRef="task_s9_sys_receivePaynetResult" />
    <sequenceFlow id="sf_s9_sys_12" sourceRef="task_s9_sys_receivePaynetResult" targetRef="task_s9_sys_generateReceipt" />
    <sequenceFlow id="sf_s9_sys_13" sourceRef="task_s9_sys_generateReceipt" targetRef="task_s9_sys_sendReceipt" />
    <sequenceFlow id="sf_s9_sys_14" sourceRef="task_s9_sys_sendReceipt" targetRef="task_s9_sys_updateTenantView" />
    <sequenceFlow id="sf_s9_sys_15" sourceRef="task_s9_sys_updateTenantView" targetRef="end_s9_sys" />

    <!-- ─── Step 10: Tenant Change — System side ─── -->
    <!-- 10.1 Move-Out -->
    <startEvent id="start_s10_sys" name="Lease terminated" />
    <task id="task_s10_sys_updateStatus" name="Update tenant-assigned accounts → Unassigned" />
    <task id="task_s10_sys_sendAlert" name="Send vacancy alert to Owner" />
    <endEvent id="end_s10_sys" name="Alert sent" />

    <sequenceFlow id="sf_s10_sys_1" sourceRef="start_s10_sys" targetRef="task_s10_sys_updateStatus" />
    <sequenceFlow id="sf_s10_sys_2" sourceRef="task_s10_sys_updateStatus" targetRef="task_s10_sys_sendAlert" />
    <sequenceFlow id="sf_s10_sys_3" sourceRef="task_s10_sys_sendAlert" targetRef="end_s10_sys" />
  </process>

  <!-- ===================================================================== -->
  <!-- PROCESS: PAYNET                                                       -->
  <!-- ===================================================================== -->
  <process id="Process_Paynet" name="Paynet" isExecutable="false">

    <!-- ─── Step 5: Validate Account Number ─── -->
    <startEvent id="start_s5_pn" name="Validation request received" />
    <task id="task_s5_pn_receiveValidation" name="Receive account validation request" />
    <task id="task_s5_pn_validateAccount" name="Validate account number against provider records" />
    <task id="task_s5_pn_sendResult" name="Return validation result (Valid / Invalid)" />
    <endEvent id="end_s5_pn" name="Validation complete" />

    <sequenceFlow id="sf_s5_pn_1" sourceRef="start_s5_pn" targetRef="task_s5_pn_receiveValidation" />
    <sequenceFlow id="sf_s5_pn_2" sourceRef="task_s5_pn_receiveValidation" targetRef="task_s5_pn_validateAccount" />
    <sequenceFlow id="sf_s5_pn_3" sourceRef="task_s5_pn_validateAccount" targetRef="task_s5_pn_sendResult" />
    <sequenceFlow id="sf_s5_pn_4" sourceRef="task_s5_pn_sendResult" targetRef="end_s5_pn" />

    <!-- ─── Step 9: Process Payment ─── -->
    <startEvent id="start_s9_pn" name="Payment request received" />
    <task id="task_s9_pn_receivePayment" name="Receive payment request from System" />
    <task id="task_s9_pn_processPayment" name="Process payment to utility provider" />
    <task id="task_s9_pn_sendResult" name="Return payment result (Success / Failure)" />
    <endEvent id="end_s9_pn" name="Payment processed" />

    <sequenceFlow id="sf_s9_pn_1" sourceRef="start_s9_pn" targetRef="task_s9_pn_receivePayment" />
    <sequenceFlow id="sf_s9_pn_2" sourceRef="task_s9_pn_receivePayment" targetRef="task_s9_pn_processPayment" />
    <sequenceFlow id="sf_s9_pn_3" sourceRef="task_s9_pn_processPayment" targetRef="task_s9_pn_sendResult" />
    <sequenceFlow id="sf_s9_pn_4" sourceRef="task_s9_pn_sendResult" targetRef="end_s9_pn" />
  </process>

</definitions>
